"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.findNativeTargetByName = exports.findFirstNativeTarget = exports.findSignableTargets = exports.getNativeTargets = exports.findApplicationTargetWithDependenciesAsync = exports.TargetType = void 0;
const BuildScheme_1 = require("./BuildScheme");
const Xcodeproj_1 = require("./utils/Xcodeproj");
var TargetType;
(function (TargetType) {
    TargetType["APPLICATION"] = "com.apple.product-type.application";
    TargetType["EXTENSION"] = "com.apple.product-type.app-extension";
    TargetType["STICKER_PACK_EXTENSION"] = "com.apple.product-type.app-extension.messages-sticker-pack";
    TargetType["OTHER"] = "other";
})(TargetType = exports.TargetType || (exports.TargetType = {}));
async function findApplicationTargetWithDependenciesAsync(projectRoot, scheme) {
    const applicationTargetName = await BuildScheme_1.getApplicationTargetNameForSchemeAsync(projectRoot, scheme);
    const project = Xcodeproj_1.getPbxproj(projectRoot);
    const [, applicationTarget] = findNativeTargetByName(project, applicationTargetName);
    const dependencies = applicationTarget.dependencies.map(({ value }) => {
        const { target: targetId } = project.getPBXGroupByKeyAndType(value, 'PBXTargetDependency');
        const [, target] = findNativeTargetById(project, targetId);
        const type = isTargetOfType(target, TargetType.EXTENSION)
            ? TargetType.EXTENSION
            : TargetType.OTHER;
        return {
            name: target.name,
            type,
        };
    });
    return {
        name: applicationTarget.name,
        type: TargetType.APPLICATION,
        dependencies,
    };
}
exports.findApplicationTargetWithDependenciesAsync = findApplicationTargetWithDependenciesAsync;
function isTargetOfType(target, targetType) {
    return target.productType === targetType || target.productType === `"${targetType}"`;
}
function getNativeTargets(project) {
    const section = project.pbxNativeTargetSection();
    return Object.entries(section).filter(Xcodeproj_1.isNotComment);
}
exports.getNativeTargets = getNativeTargets;
function findSignableTargets(project) {
    const targets = getNativeTargets(project);
    const applicationTargets = targets.filter(([, target]) => isTargetOfType(target, TargetType.APPLICATION) ||
        isTargetOfType(target, TargetType.EXTENSION) ||
        isTargetOfType(target, TargetType.STICKER_PACK_EXTENSION));
    if (applicationTargets.length === 0) {
        throw new Error(`Could not find any application targets in project.pbxproj`);
    }
    return applicationTargets;
}
exports.findSignableTargets = findSignableTargets;
function findFirstNativeTarget(project) {
    const targets = getNativeTargets(project);
    const applicationTargets = targets.filter(([, target]) => isTargetOfType(target, TargetType.APPLICATION));
    if (applicationTargets.length === 0) {
        throw new Error(`Could not find any application target in project.pbxproj`);
    }
    return applicationTargets[0];
}
exports.findFirstNativeTarget = findFirstNativeTarget;
function findNativeTargetByName(project, targetName) {
    const nativeTargets = getNativeTargets(project);
    const nativeTargetEntry = nativeTargets.find(([, i]) => i.name === targetName || i.name === `"${targetName}"`);
    if (!nativeTargetEntry) {
        throw new Error(`Could not find target '${targetName}' in project.pbxproj`);
    }
    return nativeTargetEntry;
}
exports.findNativeTargetByName = findNativeTargetByName;
function findNativeTargetById(project, targetId) {
    const nativeTargets = getNativeTargets(project);
    const nativeTargetEntry = nativeTargets.find(([key]) => key === targetId);
    if (!nativeTargetEntry) {
        throw new Error(`Could not find target with id '${targetId}' in project.pbxproj`);
    }
    return nativeTargetEntry;
}
//# sourceMappingURL=Target.js.map